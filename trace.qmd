---
title: "Trace"
page-layout: article
---

<div class="fig-card">
  <h2>Farm-to-Fork Trace</h2>
  <div id="content">Loading…</div>
  <p class="small muted">Powered by FIG (Farm In Grid)</p>
</div>

<style>
  .fig-card{max-width:760px;margin:0 auto;background:#fff;border-radius:12px;
            box-shadow:0 6px 16px rgba(0,0,0,.08);padding:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pill{display:inline-block;background:#eef6ee;color:#247c2f;padding:4px 8px;border-radius:999px;margin:3px 6px 0 0}
  .muted{color:#666}.small{font-size:.9rem}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // TODO: paste your Firebase web config
  const firebaseConfig = {
    apiKey: "YOUR_WEB_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    appId: "YOUR_APP_ID"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const params = new URLSearchParams(location.search);
  const batchId = params.get("batch_id");
  const mount = document.getElementById("content");

  if(!batchId){ mount.textContent = "Missing batch_id in URL."; throw new Error("no batch_id"); }

  (async () => {
    // Read sanitized public copy
    const snap = await get(child(ref(db), `public/batches/${batchId}`));
    if(!snap.exists()){ mount.innerHTML = `<p>Trace not found for <code>${batchId}</code>.</p>`; return; }
    const d = snap.val();

    mount.innerHTML = `
      <div class="grid">
        <div><b>Batch</b><br>${d.batch_id || "-"}</div>
        <div><b>Crop</b><br>${d.crop || "-"}</div>
        <div><b>Farmer</b><br>${d.farmer_name || d.farmer_id || "-"}</div>
        <div><b>Harvest date</b><br>${d.harvest_date || "-"}</div>
        <div><b>Area (ha)</b><br>${d.area_ha ?? "-"}</div>
        <div><b>GPS</b><br>${d.gps || "-"}</div>
      </div>

      <p><b>Inputs</b><br>
        ${(d.inputs||[]).map(x => `<span class="pill">${x}</span>`).join(" ") || "<span class='muted'>—</span>"}
      </p>
      <p><b>Certifications</b><br>
        ${(d.certifications||[]).map(x => `<span class="pill">${x}</span>`).join(" ") || "<span class='muted'>—</span>"}
      </p>

      ${ (d.events)
          ? `<h3>Lifecycle</h3>
             <ul>${Object.values(d.events).map(e =>
                  `<li><b>${e.stage}</b> — ${e.created_at || ""} ${
                     e.payload ? `: <span class='muted small'>${JSON.stringify(e.payload)}</span>` : ""}</li>`
                ).join("")}</ul>`
          : "" }
    `;
  })().catch(err => {
    console.error(err);
    mount.innerHTML = `<p style='color:#b00020'>Failed to load trace.</p>`;
  });
</script>
