---
title: "FIG — Farmer Profile"
page-layout: article
format:
  html:
    toc: false
---

<div id="app" class="fig-card">Loading…</div>

<style>
  :root{--ink:#1b1b1b;--muted:#666;--brand:#227a37;--bg:#f6f7f7}
  body{background:var(--bg)}
  .fig-card{max-width:960px;margin:18px auto;background:#fff;border-radius:14px;
            box-shadow:0 8px 24px rgba(0,0,0,.07);padding:18px}
  .header{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .avatar{width:120px;height:120px;border-radius:12px;object-fit:cover;border:1px solid #e9e9e9;background:#fafafa}
  h1{font-size:1.6rem;margin:.2rem 0}
  .meta{color:var(--muted);font-size:.92rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:14px}
  .box{border:1px solid #e8e8e8;border-radius:10px;padding:12px;background:#fff}
  .small{font-size:.9rem} .muted{color:#666}
  .hero{width:100%;border-radius:12px;border:1px solid #eee;object-fit:cover;background:#fafafa;max-height:260px}
  .pill{display:inline-block;background:#eaf6ee;color:#206d33;border:1px solid #d9eddc;padding:3px 8px;border-radius:999px;margin:3px 6px 0 0;font-size:.85rem}
</style>

<script>
// --- CONFIG: your RTDB base URL (no keys needed)
const RTDB = "https://fig-1-41cec-default-rtdb.asia-southeast1.firebasedatabase.app";

// --- helpers
const esc = (s) => String(s||"").replace(/[&<>"']/g, m => (
  {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
));
const $ = (id) => document.getElementById(id);

// --- main
(async () => {
  const qs = new URLSearchParams(location.search);
  const fig = qs.get("fig_id");
  const mount = $("app");

  if(!fig){
    mount.innerHTML = "<h2>Missing FIG ID</h2><p class='muted'>Open with <code>?fig_id=FIG-XXXXX-XXXXX</code>.</p>";
    return;
  }

  try {
    // Read ONLY public mirror
    const pf  = await fetch(`${RTDB}/public/farmers/${encodeURIComponent(fig)}.json`).then(r=>r.json());
    const ent = await fetch(`${RTDB}/public/traces/${encodeURIComponent(fig)}/entries.json`).then(r=>r.json()).catch(()=> ({}));

    if(!pf){
      mount.innerHTML = `<h2>Not found</h2><p class='muted'>No public profile for <code>${esc(fig)}</code>.</p>`;
      return;
    }

    const entries = ent || {};
    const entriesHTML = Object.keys(entries).length
      ? Object.values(entries)
          .sort((a,b) => (b.created_at||"").localeCompare(a.created_at||""))
          .map(e => `
            <div class="box">
              <div><b>${esc(e.batch_id||"")}</b> — ${esc(e.crop||"")}</div>
              <div class="small muted">Harvest: ${esc(e.harvest_date||"—")}${e.variety? " • Variety: "+esc(e.variety):""}</div>
              ${Array.isArray(e.inputs) && e.inputs.length ? `<div style="margin-top:6px">${e.inputs.map(x=>`<span class="pill">${esc(x)}</span>`).join(" ")}</div>`:""}
              ${Array.isArray(e.certifications) && e.certifications.length ? `<div style="margin-top:6px">${e.certifications.map(x=>`<span class="pill">${esc(x)}</span>`).join(" ")}</div>`:""}
            </div>
          `).join("")
      : `<p class="muted">No entries published yet.</p>`;

    mount.innerHTML = `
      <div class="header">
        ${pf.photo_farmer ? `<img class="avatar" src="${esc(pf.photo_farmer)}" alt="Farmer">` : `<div class="avatar"></div>`}
        <div>
          <h1>${esc(pf.farmer_name || fig)}</h1>
          <div class="meta">FIG ID: ${esc(fig)} ${pf.verification ? "• "+esc(pf.verification) : ""}</div>
          ${pf.updated_at ? `<div class="small muted">Updated: ${esc(pf.updated_at)}</div>` : ""}
        </div>
      </div>

      ${pf.photo_farm ? `<img class="hero" src="${esc(pf.photo_farm)}" alt="Farm photo">` : ""}

      <div class="grid" style="margin-top:14px">
        <div class="box"><b>Verification</b><br>${esc(pf.verification || "pending")}</div>
        ${pf.org_id ? `<div class="box"><b>Organization</b><br>${esc(pf.org_id)}</div>` : ""}
      </div>

      <h2 style="margin-top:16px">Entries</h2>
      <div class="grid">${entriesHTML}</div>
    `;
  } catch (e) {
    console.error(e);
    mount.innerHTML = `<p style="color:#b00020">Failed to load.</p>`;
  }
})();
</script>
